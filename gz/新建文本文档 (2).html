<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®‰å…¨èŠå¤©å®¤</title>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; padding: 20px; max-width: 600px; margin: auto; }
    #chat-box { border: 1px solid #ccc; background: #fff; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 15px; }
    .message { margin: 8px 0; font-size: 14px; color: #333; }
    .self { color: #0066cc; }
    .timestamp { font-size: 12px; color: #999; margin-left: 5px; }
    input, button { padding: 6px; font-size: 14px; }
    #ip-display { margin-bottom: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>ğŸ’¬ å®‰å…¨èŠå¤©å®¤</h2>
<div id="ip-display">ğŸ” æ­£åœ¨è·å– IP åœ°å€...</div>

<div id="chat-box"></div>

<input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." /><br><br>

<label for="captcha-input">è¯·è¾“å…¥éªŒè¯ç ï¼š<b id="captcha-code"></b></label><br>
<input type="text" id="captcha-input" placeholder="è¾“å…¥ä¸Šæ–¹éªŒè¯ç " /><br><br>

<button id="send-btn">å‘é€</button>

<script>
  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const captchaInput = document.getElementById('captcha-input');
  const captchaCodeEl = document.getElementById('captcha-code');
  const ipDisplay = document.getElementById('ip-display');

  // è·å–ç”¨æˆ·å…¬ç½‘ IP
  let userIP = 'æœªçŸ¥';
fetch('https://api.ip.sb/geoip')
  .then(res => res.json())
  .then(data => {
    userIP = data.ip;
    ipDisplay.textContent = `ğŸ§­ æ‚¨çš„ IP åœ°å€ï¼š${userIP}`;
  })


    .catch(() => {
      ipDisplay.textContent = `âš ï¸ æ— æ³•è·å– IP åœ°å€`;
    });

  // éšæœºéªŒè¯ç ç”Ÿæˆ
  function generateCaptcha() {
    const code = Math.random().toString(36).substring(2, 6).toUpperCase();
    captchaCodeEl.textContent = code;
    return code;
  }

  let currentCaptcha = generateCaptcha();

  // åŠ è½½æœ¬åœ°å†å²è®°å½•
  const savedChat = JSON.parse(localStorage.getItem('chatHistory')) || [];
  savedChat.forEach(msg => addMessage(msg.text, msg.ip, msg.time));

  // æ·»åŠ æ¶ˆæ¯
  function addMessage(text, ip, time) {
    const msg = document.createElement('div');
    msg.className = 'message self';
    const timestamp = time || new Date().toLocaleString();
    msg.innerHTML = `ä½ ï¼ˆIP: ${ip}ï¼‰ï¼š${text}<span class="timestamp">[${timestamp}]</span>`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  sendBtn.onclick = () => {
    const text = input.value.trim();
    const captchaText = captchaInput.value.trim().toUpperCase();

    if (!text) return;
    if (captchaText !== currentCaptcha) {
      alert("éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
      currentCaptcha = generateCaptcha();
      captchaInput.value = '';
      return;
    }

    const timeNow = new Date().toLocaleString();
    addMessage(text, userIP, timeNow);

    // ä¿å­˜åˆ° localStorage
    savedChat.push({ text, ip: userIP, time: timeNow });
    localStorage.setItem('chatHistory', JSON.stringify(savedChat));

    input.value = '';
    captchaInput.value = '';
    currentCaptcha = generateCaptcha();
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendBtn.click();
  });
</script>

</body>
</html>
