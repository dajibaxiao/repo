<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>安全聊天室</title>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; padding: 20px; max-width: 600px; margin: auto; }
    #chat-box { border: 1px solid #ccc; background: #fff; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 15px; }
    .message { margin: 8px 0; font-size: 14px; color: #333; }
    .self { color: #0066cc; }
    .timestamp { font-size: 12px; color: #999; margin-left: 5px; }
    input, button { padding: 6px; font-size: 14px; }
    #ip-display { margin-bottom: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>💬 安全聊天室</h2>
<div id="ip-display">🔍 正在获取 IP 地址...</div>

<div id="chat-box"></div>

<input type="text" id="message-input" placeholder="输入消息..." /><br><br>

<label for="captcha-input">请输入验证码：<b id="captcha-code"></b></label><br>
<input type="text" id="captcha-input" placeholder="输入上方验证码" /><br><br>

<button id="send-btn">发送</button>

<script>
  const chatBox = document.getElementById('chat-box');
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const captchaInput = document.getElementById('captcha-input');
  const captchaCodeEl = document.getElementById('captcha-code');
  const ipDisplay = document.getElementById('ip-display');

  // 获取用户公网 IP
  let userIP = '未知';
fetch('https://api.ip.sb/geoip')
  .then(res => res.json())
  .then(data => {
    userIP = data.ip;
    ipDisplay.textContent = `🧭 您的 IP 地址：${userIP}`;
  })


    .catch(() => {
      ipDisplay.textContent = `⚠️ 无法获取 IP 地址`;
    });

  // 随机验证码生成
  function generateCaptcha() {
    const code = Math.random().toString(36).substring(2, 6).toUpperCase();
    captchaCodeEl.textContent = code;
    return code;
  }

  let currentCaptcha = generateCaptcha();

  // 加载本地历史记录
  const savedChat = JSON.parse(localStorage.getItem('chatHistory')) || [];
  savedChat.forEach(msg => addMessage(msg.text, msg.ip, msg.time));

  // 添加消息
  function addMessage(text, ip, time) {
    const msg = document.createElement('div');
    msg.className = 'message self';
    const timestamp = time || new Date().toLocaleString();
    msg.innerHTML = `你（IP: ${ip}）：${text}<span class="timestamp">[${timestamp}]</span>`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  sendBtn.onclick = () => {
    const text = input.value.trim();
    const captchaText = captchaInput.value.trim().toUpperCase();

    if (!text) return;
    if (captchaText !== currentCaptcha) {
      alert("验证码错误，请重新输入！");
      currentCaptcha = generateCaptcha();
      captchaInput.value = '';
      return;
    }

    const timeNow = new Date().toLocaleString();
    addMessage(text, userIP, timeNow);

    // 保存到 localStorage
    savedChat.push({ text, ip: userIP, time: timeNow });
    localStorage.setItem('chatHistory', JSON.stringify(savedChat));

    input.value = '';
    captchaInput.value = '';
    currentCaptcha = generateCaptcha();
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendBtn.click();
  });
</script>

</body>
</html>
